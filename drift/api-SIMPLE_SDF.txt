note
	description: "[
				SIMPLE_SDF - Facade class for Signed Distance Field operations.
		
				Provides factory methods for creating:
				- Vectors (2D and 3D)
				- Primitive shapes (sphere, box, capsule, cylinder, torus, plane)
				- Boolean operations
				- Scenes (composition of shapes)
				- Ray marching for rendering
		
				Usage:
					local
						sdf: SIMPLE_SDF
						s: SDF_SCENE
						sphere: SDF_SPHERE
						box: SDF_BOX
						marcher: SDF_RAY_MARCHER
						hit: SDF_RAY_HIT
					do
						create sdf
						s := sdf.scene
						s.add (sdf.sphere (1.0))
						s.add_smooth_union (sdf.cube (1.5), 0.2)
						marcher := sdf.ray_marcher
						hit := marcher.march (s, origin, direction)
					end
	]"
	author: "Larry Rix"
	date: "$Date$"
	revision: "$Revision$"

class interface
	SIMPLE_SDF

create 
	default_create
			-- Process instances of classes with no creation clause.
			-- (Default: do nothing.)
			-- (from ANY)

feature -- Access

	generating_type: TYPE [detachable SIMPLE_SDF]
			-- Type of current object
			-- (type of which it is a direct instance)
			-- (from ANY)
		ensure -- from ANY
			generating_type_not_void: Result /= Void

	generator: STRING_8
			-- Name of current object's generating class
			-- (base class of the type of which it is a direct instance)
			-- (from ANY)
		ensure -- from ANY
			generator_not_void: Result /= Void
			generator_not_empty: not Result.is_empty
	
feature -- Comparison

	frozen deep_equal (a: detachable ANY; b: like arg #1): BOOLEAN
			-- Are `a` and `b` either both void
			-- or attached to isomorphic object structures?
			-- (from ANY)
		ensure -- from ANY
			instance_free: class
			shallow_implies_deep: standard_equal (a, b) implies Result
			both_or_none_void: (a = Void) implies (Result = (b = Void))
			same_type: (Result and (a /= Void)) implies (b /= Void and then a.same_type (b))
			symmetric: Result implies deep_equal (b, a)

	frozen equal (a: detachable ANY; b: like arg #1): BOOLEAN
			-- Are `a` and `b` either both void or attached
			-- to objects considered equal?
			-- (from ANY)
		ensure -- from ANY
			instance_free: class
			definition: Result = (a = Void and b = Void) or else ((a /= Void and b /= Void) and then a.is_equal (b))

	frozen is_deep_equal alias "≡≡≡" (other: SIMPLE_SDF): BOOLEAN
			-- Are `Current` and `other` attached to isomorphic object structures?
			-- (from ANY)
		require -- from ANY
			other_not_void: other /= Void
		ensure -- from ANY
			shallow_implies_deep: standard_is_equal (other) implies Result
			same_type: Result implies same_type (other)
			symmetric: Result implies other.is_deep_equal (Current)

	is_equal (other: SIMPLE_SDF): BOOLEAN
			-- Is `other` attached to an object considered
			-- equal to current object?
			-- (from ANY)
		require -- from ANY
			other_not_void: other /= Void
		ensure -- from ANY
			symmetric: Result implies other ~ Current
			consistent: standard_is_equal (other) implies Result

	frozen standard_equal (a: detachable ANY; b: like arg #1): BOOLEAN
			-- Are `a` and `b` either both void or attached to
			-- field-by-field identical objects of the same type?
			-- Always uses default object comparison criterion.
			-- (from ANY)
		ensure -- from ANY
			instance_free: class
			definition: Result = (a = Void and b = Void) or else ((a /= Void and b /= Void) and then a.standard_is_equal (b))

	frozen standard_is_equal alias "≜" (other: SIMPLE_SDF): BOOLEAN
			-- Is `other` attached to an object of the same type
			-- as current object, and field-by-field identical to it?
			-- (from ANY)
		require -- from ANY
			other_not_void: other /= Void
		ensure -- from ANY
			same_type: Result implies same_type (other)
			symmetric: Result implies other.standard_is_equal (Current)
	
feature -- Status report

	conforms_to (other: ANY): BOOLEAN
			-- Does type of current object conform to type
			-- of `other` (as per Eiffel: The Language, chapter 13)?
			-- (from ANY)
		require -- from ANY
			other_not_void: other /= Void

	same_type (other: ANY): BOOLEAN
			-- Is type of current object identical to type of `other`?
			-- (from ANY)
		require -- from ANY
			other_not_void: other /= Void
		ensure -- from ANY
			definition: Result = (conforms_to (other) and other.conforms_to (Current))
	
feature -- Duplication

	copy (other: SIMPLE_SDF)
			-- Update current object using fields of object attached
			-- to `other`, so as to yield equal objects.
			-- (from ANY)
		require -- from ANY
			other_not_void: other /= Void
			type_identity: same_type (other)
		ensure -- from ANY
			is_equal: Current ~ other

	frozen deep_copy (other: SIMPLE_SDF)
			-- Effect equivalent to that of:
			--		`copy` (`other` . `deep_twin`)
			-- (from ANY)
		require -- from ANY
			other_not_void: other /= Void
		ensure -- from ANY
			deep_equal: deep_equal (Current, other)

	frozen deep_twin: SIMPLE_SDF
			-- New object structure recursively duplicated from Current.
			-- (from ANY)
		ensure -- from ANY
			deep_twin_not_void: Result /= Void
			deep_equal: deep_equal (Current, Result)

	frozen standard_copy (other: SIMPLE_SDF)
			-- Copy every field of `other` onto corresponding field
			-- of current object.
			-- (from ANY)
		require -- from ANY
			other_not_void: other /= Void
			type_identity: same_type (other)
		ensure -- from ANY
			is_standard_equal: standard_is_equal (other)

	frozen standard_twin: SIMPLE_SDF
			-- New object field-by-field identical to `other`.
			-- Always uses default copying semantics.
			-- (from ANY)
		ensure -- from ANY
			standard_twin_not_void: Result /= Void
			equal: standard_equal (Result, Current)

	frozen twin: SIMPLE_SDF
			-- New object equal to `Current`
			-- `twin` calls `copy`; to change copying/twinning semantics, redefine `copy`.
			-- (from ANY)
		ensure -- from ANY
			twin_not_void: Result /= Void
			is_equal: Result ~ Current
	
feature -- Basic operations

	frozen default: detachable SIMPLE_SDF
			-- Default value of object's type
			-- (from ANY)

	frozen default_pointer: POINTER
			-- Default value of type `POINTER`
			-- (Avoid the need to write `p`.`default` for
			-- some `p` of type `POINTER`.)
			-- (from ANY)
		ensure -- from ANY
			instance_free: class

	default_rescue
			-- Process exception for routines with no Rescue clause.
			-- (Default: do nothing.)
			-- (from ANY)

	frozen do_nothing
			-- Execute a null action.
			-- (from ANY)
		ensure -- from ANY
			instance_free: class
	
feature -- Convenience: Distance evaluation

	distance (a_shape: SDF_SHAPE; a_point: SDF_VEC3): REAL_64
			-- Evaluate distance from point to shape
		require
			shape_attached: a_shape /= Void
			point_attached: a_point /= Void

	union_distance (a_shapes: ARRAY [SDF_SHAPE]; a_point: SDF_VEC3): REAL_64
			-- Distance to union of all shapes
		require
			shapes_attached: a_shapes /= Void
			has_shapes: a_shapes.count > 0
			point_attached: a_point /= Void
	
feature -- Operations

	Ops: SDF_OPS
			-- Boolean and smooth operations
		ensure
			result_attached: Result /= Void
	
feature -- Output

	Io: STD_FILES
			-- Handle to standard file setup
			-- (from ANY)
		ensure -- from ANY
			instance_free: class
			io_not_void: Result /= Void

	out: STRING_8
			-- New string containing terse printable representation
			-- of current object
			-- (from ANY)
		ensure -- from ANY
			out_not_void: Result /= Void

	print (o: detachable ANY)
			-- Write terse external representation of `o`
			-- on standard output.
			-- (from ANY)
		ensure -- from ANY
			instance_free: class

	frozen tagged_out: STRING_8
			-- New string containing terse printable representation
			-- of current object
			-- (from ANY)
		ensure -- from ANY
			tagged_out_not_void: Result /= Void
	
feature -- Platform

	Operating_environment: OPERATING_ENVIRONMENT
			-- Objects available from the operating system
			-- (from ANY)
		ensure -- from ANY
			instance_free: class
			operating_environment_not_void: Result /= Void
	
feature -- Ray Marcher Factory

	ray_marcher: SDF_RAY_MARCHER
			-- Create ray marcher with default settings
		ensure
			result_attached: Result /= Void

	ray_marcher_custom (a_max_steps: INTEGER_32; a_max_distance, a_threshold: REAL_64): SDF_RAY_MARCHER
			-- Create ray marcher with custom settings
		require
			positive_steps: a_max_steps > 0
			positive_distance: a_max_distance > 0.0
			positive_threshold: a_threshold > 0.0
		ensure
			result_attached: Result /= Void
	
feature -- Scene Factory

	scene: SDF_SCENE
			-- Create empty scene
		ensure
			result_attached: Result /= Void
			is_empty: Result.is_empty
	
feature -- Shape Factory: Box

	box (a_width, a_height, a_depth: REAL_64): SDF_BOX
			-- Create box with full dimensions at origin
		require
			positive_width: a_width > 0.0
			positive_height: a_height > 0.0
			positive_depth: a_depth > 0.0
		ensure
			result_attached: Result /= Void

	cube (a_size: REAL_64): SDF_BOX
			-- Create cube with edge length at origin
		require
			positive_size: a_size > 0.0
		ensure
			result_attached: Result /= Void
	
feature -- Shape Factory: Capsule

	capsule (a_point_a, a_point_b: SDF_VEC3; a_radius: REAL_64): SDF_CAPSULE
			-- Create capsule between two points
		require
			point_a_attached: a_point_a /= Void
			point_b_attached: a_point_b /= Void
			positive_radius: a_radius > 0.0
		ensure
			result_attached: Result /= Void

	capsule_vertical (a_height, a_radius: REAL_64): SDF_CAPSULE
			-- Create vertical capsule at origin
		require
			positive_height: a_height > 0.0
			positive_radius: a_radius > 0.0
		ensure
			result_attached: Result /= Void
	
feature -- Shape Factory: Cylinder

	cylinder (a_height, a_radius: REAL_64): SDF_CYLINDER
			-- Create vertical cylinder at origin
		require
			positive_height: a_height > 0.0
			positive_radius: a_radius > 0.0
		ensure
			result_attached: Result /= Void
	
feature -- Shape Factory: Plane

	ground_plane (a_height: REAL_64): SDF_PLANE
			-- Create horizontal ground plane (XZ) at given Y height
		ensure
			result_attached: Result /= Void

	plane (a_normal: SDF_VEC3; a_height: REAL_64): SDF_PLANE
			-- Create plane with given normal and height
		require
			normal_attached: a_normal /= Void
			normal_is_unit: a_normal.is_unit_vector
		ensure
			result_attached: Result /= Void
	
feature -- Shape Factory: Sphere

	sphere (a_radius: REAL_64): SDF_SPHERE
			-- Create sphere with given radius at origin
		require
			positive_radius: a_radius > 0.0
		ensure
			result_attached: Result /= Void
			radius_set: Result.radius = a_radius

	sphere_at (a_center: SDF_VEC3; a_radius: REAL_64): SDF_SPHERE
			-- Create sphere at specified center
		require
			center_attached: a_center /= Void
			positive_radius: a_radius > 0.0
		ensure
			result_attached: Result /= Void
	
feature -- Shape Factory: Torus

	torus (a_major_radius, a_minor_radius: REAL_64): SDF_TORUS
			-- Create torus (donut) at origin
		require
			positive_major: a_major_radius > 0.0
			positive_minor: a_minor_radius > 0.0
			minor_less_than_major: a_minor_radius < a_major_radius
		ensure
			result_attached: Result /= Void
	
feature -- Vector Factory

	vec2 (a_x, a_y: REAL_64): SDF_VEC2
			-- Create 2D vector
		ensure
			result_attached: Result /= Void
			x_set: Result.x = a_x
			y_set: Result.y = a_y

	vec2_zero: SDF_VEC2
			-- Zero 2D vector
		ensure
			result_attached: Result /= Void
			is_zero: Result.is_zero_vector

	vec3 (a_x, a_y, a_z: REAL_64): SDF_VEC3
			-- Create 3D vector
		ensure
			result_attached: Result /= Void
			x_set: Result.x = a_x
			y_set: Result.y = a_y
			z_set: Result.z = a_z

	vec3_unit_x: SDF_VEC3
			-- Unit vector along X axis
		ensure
			result_attached: Result /= Void
			is_unit: Result.is_unit_vector

	vec3_unit_y: SDF_VEC3
			-- Unit vector along Y axis
		ensure
			result_attached: Result /= Void
			is_unit: Result.is_unit_vector

	vec3_unit_z: SDF_VEC3
			-- Unit vector along Z axis
		ensure
			result_attached: Result /= Void
			is_unit: Result.is_unit_vector

	vec3_zero: SDF_VEC3
			-- Zero 3D vector
		ensure
			result_attached: Result /= Void
			is_zero: Result.is_zero_vector
	
invariant
		-- from ANY
	reflexive_equality: standard_is_equal (Current)
	reflexive_conformance: conforms_to (Current)

end -- class SIMPLE_SDF

